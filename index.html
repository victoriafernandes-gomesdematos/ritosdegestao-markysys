<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ritos do Modelo de Gestão • Report + Agenda + Painel</title>
  <style>
    :root{
      --card: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.12);
      --text: rgba(255,255,255,.90);
      --muted: rgba(255,255,255,.62);
      --good:#2be4a7;
      --warn:#ffcc66;
      --bad:#ff5c7a;
      --info:#7c5cff;
      --shadow: 0 24px 80px rgba(0,0,0,.45);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html, body{ height: 100%; overflow-y: auto; }

    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(124,92,255,.25), transparent 60%),
        radial-gradient(900px 700px at 75% 15%, rgba(0,212,255,.18), transparent 55%),
        radial-gradient(1000px 700px at 70% 90%, rgba(43,228,167,.12), transparent 55%),
        linear-gradient(180deg, #070a14 0%, #0b1020 50%, #070a14 100%);
      overflow-x:hidden;
    }

    .wrap{max-width: 1280px; margin: 0 auto; padding: 28px 18px 42px;}

    header{
      display:flex; gap:16px; align-items:center; justify-content:space-between;
      margin-bottom:18px; flex-wrap:wrap;
    }

    .brand{display:flex; gap:14px; align-items:center; flex-wrap:wrap;}
    .title h1{margin:0; font-size:18px; font-weight:720; letter-spacing:.2px;}
    .title p{margin:2px 0 0; font-size:12.5px; color:var(--muted)}

    /* Headline logos */
    .logos{
      display:flex;
      align-items:center;
      gap:12px;
      padding:10px 12px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
      backdrop-filter: blur(10px);
      box-shadow: 0 14px 40px rgba(0,0,0,.22);
    }
    .logo-img{
      height:34px;
      width:auto;
      display:block;
      object-fit:contain;
      filter: drop-shadow(0 10px 22px rgba(0,0,0,.35));
    }
    .logo-img.gdm{
      height:30px;
      opacity:.95;
    }
    .logo-sep{
      width:1px;
      height:26px;
      background: rgba(255,255,255,.14);
      border-radius: 999px;
    }
    @media (max-width: 560px){
      .logos{width:100%; justify-content:center;}
    }

    .top-actions{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; align-items:center;}
    .pill{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      padding:8px 10px;
      border-radius: 999px;
      display:flex; gap:8px; align-items:center;
      backdrop-filter: blur(10px);
      box-shadow: 0 14px 40px rgba(0,0,0,.25);
    }
    .pill label{font-size:12px; color:var(--muted)}
    .pill input,.pill select{color:var(--text); background:transparent; border:0; outline:none; font-size:12.5px;}
    .pill input[type="month"]{color-scheme: dark;}

    .btn{
      cursor:pointer;
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      color:var(--text);
      padding:9px 12px;
      border-radius: 999px;
      font-size:12.5px;
      transition: transform .06s ease, border-color .2s ease;
      box-shadow: 0 16px 50px rgba(0,0,0,.28);
      user-select:none;
    }
    .btn:hover{transform: translateY(-1px); border-color: rgba(255,255,255,.22)}
    .btn.primary{
      border-color: rgba(124,92,255,.35);
      background: linear-gradient(135deg, rgba(124,92,255,.9), rgba(0,212,255,.5));
      box-shadow: 0 18px 70px rgba(124,92,255,.22);
    }

    .nav{
      display:flex; gap:8px; align-items:center;
      padding:6px;
      border:1px solid rgba(255,255,255,.12);
      border-radius: 999px;
      background: rgba(0,0,0,.18);
      backdrop-filter: blur(10px);
    }
    .nav button{ box-shadow:none; }
    .nav .active{
      border-color: rgba(124,92,255,.35);
      background: rgba(124,92,255,.16);
    }

    .grid{ display:grid; grid-template-columns: 1fr; gap:14px; align-items: start; }
    @media (min-width: 1040px){ .grid{grid-template-columns: 460px 1fr;} }

    .card{
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: 28px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      overflow: visible;
    }
    @media (min-width: 1040px){
      .card{ max-height: calc(100vh - 170px); overflow: auto; }
    }

    .card .hd{
      padding: 16px 16px 12px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      position: sticky; top: 0;
      background: rgba(10,14,28,.72);
      backdrop-filter: blur(12px);
      z-index: 2;
    }
    .card .hd h2{margin:0; font-size:14.5px;}
    .card .hd p{margin:4px 0 0; font-size:12px; color:var(--muted); line-height:1.35;}
    .card .bd{padding: 14px 16px 16px;}

    .form{display:grid; gap:10px;}
    .row{display:grid; gap:10px; grid-template-columns: 1fr;}
    @media (min-width: 520px){ .row{grid-template-columns: 1fr 1fr;} }

    .field{
      background: rgba(0,0,0,.14);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      padding: 10px 12px;
      display:flex; flex-direction:column; gap:6px;
    }
    .field label{font-size:11.5px; color:var(--muted);}
    .field input, .field select, .field textarea{
      border:0; outline:none; background:transparent; color:var(--text); font-size:13.5px;
    }
    .field textarea{min-height:72px; resize: vertical}

    .help{font-size:11.5px; color:var(--muted); line-height:1.4;}
    .mono{font-family:var(--mono)}
    .muted{color:var(--muted)}
    .right{text-align:right}

    .table{
      width:100%; border-collapse: collapse;
      overflow:hidden; border-radius: 18px;
      border:1px solid rgba(255,255,255,.10);
    }
    .table th, .table td{
      padding: 10px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      text-align:left; font-size:12.5px; vertical-align: top;
    }
    .table th{font-size:11.5px; color:var(--muted); background: rgba(255,255,255,.04);}
    .table tr:last-child td{border-bottom:0}

    .tag{
      display:inline-flex; align-items:center; gap:8px;
      font-size:11.5px; color:var(--muted);
      padding:6px 10px;
      border:1px solid rgba(255,255,255,.10);
      border-radius: 999px;
      background: rgba(0,0,0,.14);
      white-space:nowrap;
    }
    .dot{width:8px; height:8px; border-radius:999px; background: rgba(255,255,255,.35);}
    .dot.good{background: var(--good)}
    .dot.warn{background: var(--warn)}
    .dot.bad{background: var(--bad)}
    .dot.info{background: var(--info)}

    details{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.12);
      border-radius: 18px;
      overflow:hidden;
      margin-top:10px;
    }
    summary{
      list-style:none; cursor:pointer; padding:10px 12px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      user-select:none;
    }
    summary::-webkit-details-marker{display:none}
    .sum-left{display:flex; flex-direction:column; gap:2px}
    .sum-left .t{font-size:12.5px; font-weight:650}
    .sum-left .s{font-size:11.5px; color:var(--muted)}
    .sum-right{display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end}

    .task-list{padding: 10px 12px 12px; display:grid; gap:10px;}
    .task-row{
      display:grid; gap:10px;
      grid-template-columns: 1.5fr .8fr 1fr .9fr;
      align-items:start;
    }
    @media (max-width: 780px){ .task-row{grid-template-columns: 1fr;} }

    .task{
      padding: 10px 10px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    .task .grid4{
      display:grid; gap:10px;
      grid-template-columns: 1.6fr .8fr 1fr .9fr;
      align-items:end;
    }
    @media (max-width: 860px){ .task .grid4{grid-template-columns: 1fr;} }

    .badge{
      padding:6px 10px; border-radius: 999px; font-size:11.5px;
      border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.04);
      display:inline-flex; gap:8px; align-items:center; white-space:nowrap;
    }
    .badge.good{border-color: rgba(43,228,167,.25); background: rgba(43,228,167,.10)}
    .badge.bad{border-color: rgba(255,92,122,.25); background: rgba(255,92,122,.10)}
    .badge.warn{border-color: rgba(255,204,102,.25); background: rgba(255,204,102,.10)}
    .badge.info{border-color: rgba(124,92,255,.25); background: rgba(124,92,255,.10)}
    .badge.neutral{border-color: rgba(255,255,255,.14); background: rgba(255,255,255,.06)}

    .task-actions{display:flex; gap:8px; justify-content:flex-end; align-items:center; flex-wrap:wrap;}
    .tiny-btn{
      padding:7px 10px; font-size:12px; border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      cursor:pointer; color:var(--text);
    }

    /* ------------------ AGENDA (calendário) ------------------ */
    .agenda-shell{display:grid; gap:12px; grid-template-columns: 1fr;}
    @media (min-width: 1040px){ .agenda-shell{grid-template-columns: 420px 1fr;} }

    .list{display:grid; gap:10px;}
    .rito-item{
      border:1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      background: rgba(0,0,0,.12);
      padding: 12px;
      display:flex; justify-content:space-between; gap:10px; align-items:flex-start;
      cursor:pointer;
      transition: transform .06s ease, border-color .2s ease;
    }
    .rito-item:hover{ transform: translateY(-1px); border-color: rgba(255,255,255,.20); }
    .rito-item.active{ border-color: rgba(124,92,255,.40); background: rgba(124,92,255,.10); }
    .rito-item .t{font-weight:700; font-size:12.8px;}
    .rito-item .s{font-size:11.5px; color:var(--muted); margin-top:2px;}
    .rito-item .rightCol{display:flex; flex-direction:column; gap:6px; align-items:flex-end;}

    .bar{
      height:10px;
      width:140px;
      border-radius:999px;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }
    .bar > div{
      height:100%;
      width:0%;
      border-radius:999px;
      background: linear-gradient(90deg, rgba(124,92,255,.95), rgba(0,212,255,.75));
      transition: width .25s ease;
    }

    .cal{
      border:1px solid rgba(255,255,255,.10);
      border-radius: 22px;
      background: rgba(0,0,0,.12);
      overflow:hidden;
    }

    .cal-head{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      padding: 12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
    }
    .cal-head .left{display:flex; flex-direction:column; gap:2px;}
    .cal-head .left .h{font-weight:780;}
    .cal-head .left .p{font-size:11.5px; color:var(--muted)}

    .cal-grid{ display:grid; grid-template-columns: repeat(7, 1fr); }
    .dow{
      padding:10px 10px;
      font-size:11.5px;
      color:var(--muted);
      border-bottom:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.02);
    }

    .cell{
      min-height: 108px;
      padding: 10px 10px;
      border-right:1px solid rgba(255,255,255,.06);
      border-bottom:1px solid rgba(255,255,255,.06);
      position:relative;
      background: rgba(0,0,0,.06);
      cursor:pointer;
    }
    .cell:nth-child(7n){border-right:0}
    .cell .day{
      position:absolute; top:8px; right:10px;
      font-size:11.5px; color: rgba(255,255,255,.70);
      font-family: var(--mono);
    }
    .cell.muted{opacity:.35; cursor:default}
    .cell.today{outline: 1px solid rgba(0,212,255,.35); outline-offset:-1px; background: rgba(0,212,255,.05);}
    .cell:hover{background: rgba(255,255,255,.04)}

    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px;
      border-radius: 999px;
      font-size:11.5px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      margin-top: 28px;
      max-width: 100%;
    }
    .chip.good{ border-color: rgba(43,228,167,.25); background: rgba(43,228,167,.10); }
    .chip.info{ border-color: rgba(124,92,255,.25); background: rgba(124,92,255,.10); }
    .chip.warn{ border-color: rgba(255,204,102,.25); background: rgba(255,204,102,.10); }
    .chip.bad{ border-color: rgba(255,92,122,.25); background: rgba(255,92,122,.10); }
    .chip .x{font-family: var(--mono); opacity:.75;}

    .stack{display:flex; flex-wrap:wrap; gap:8px; margin-top: 10px;}
    .miniDot{width:8px; height:8px; border-radius:999px; background: rgba(255,255,255,.35); border:1px solid rgba(255,255,255,.14)}
    .miniDot.good{background: rgba(43,228,167,.9)}
    .miniDot.info{background: rgba(124,92,255,.9)}

    /* ------------------ DASHBOARD ------------------ */
    .kpis{display:grid; gap:10px; grid-template-columns: 1fr;}
    @media (min-width: 840px){ .kpis{grid-template-columns: 1fr 1fr 1fr 1fr;} }

    .kpi{
      border:1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      background: rgba(0,0,0,.12);
      padding: 12px;
      display:flex; flex-direction:column; gap:6px;
    }
    .kpi .t{font-size:11.5px; color:var(--muted)}
    .kpi .v{font-size:18px; font-weight:800; letter-spacing:.2px}
    .kpi .s{font-size:11.5px; color:var(--muted)}

    .chartBox{
      border:1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      background: rgba(0,0,0,.12);
      padding: 12px;
    }

    .row2{display:grid; gap:12px; grid-template-columns: 1fr;}
    @media (min-width: 1040px){ .row2{grid-template-columns: 1fr 1fr;} }

    .toast{
      position: fixed; left: 50%; transform: translateX(-50%);
      bottom: 18px; padding: 10px 12px; border-radius: 999px;
      background: rgba(0,0,0,.5); border: 1px solid rgba(255,255,255,.14);
      color: rgba(255,255,255,.9);
      backdrop-filter: blur(10px); box-shadow: 0 18px 60px rgba(0,0,0,.4);
      font-size: 12.5px; opacity:0; pointer-events:none;
      transition: opacity .25s ease, transform .25s ease;
      z-index: 99;
    }
    .toast.show{opacity:1; transform: translateX(-50%) translateY(-4px);}
    .hidden{display:none !important;}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <!-- ✅ Logos (coloque os PNGs na mesma pasta do HTML) -->
        <div class="logos" title="Marksys + Gomes de Matos Consultoria">
          <img class="logo-img" src="assets/logo-marksys.png" alt="Marksys" />
          <span class="logo-sep" aria-hidden="true"></span>
          <img class="logo-img gdm" src="assets/logo-gomes.png" alt="Gomes de Matos Consultoria" />
        </div>

        <div class="title">
          <h1>Ritos do Modelo de Gestão</h1>
          <p>Agenda (previsto) → Report (executado) → Painel (cumprimento + encaminhamentos).</p>
        </div>
      </div>

      <div class="top-actions">
        <div class="nav" role="tablist" aria-label="Navegação">
          <button class="btn" id="tabAgenda" aria-selected="false">Agenda</button>
          <button class="btn" id="tabReport" aria-selected="true">Report</button>
          <button class="btn" id="tabDash" aria-selected="false">Painel</button>
        </div>

        <div class="pill">
          <label for="month">Semestre</label>
          <input id="month" type="month" />
        </div>

        <button class="btn" id="btnDemo">Carregar exemplo</button>
        <button class="btn" id="btnClear">Zerar dados</button>
      </div>
    </header>

    <!-- ============================ AGENDA ============================ -->
    <section id="pageAgenda" class="hidden" aria-label="Agenda">
      <div class="card" style="margin-bottom:14px;">
        <div class="hd">
          <div>
            <h2>Agenda de ritos</h2>
            <p>Selecione um rito e marque as datas no calendário. Quando você registrar a execução no <b>Report</b>, o previsto vira <b>Executado</b> automaticamente.</p>
          </div>
          <span class="tag"><span class="dot info"></span><span class="mono">previsto → executado</span></span>
        </div>
        <div class="bd">
          <div class="agenda-shell">
            <div>
              <div class="field" style="margin-bottom:10px;">
                <label for="agendaRite">Rito selecionado</label>
                <select id="agendaRite"></select>
              </div>

              <div class="help" id="agendaHint" style="margin-bottom:10px;">—</div>
              <div class="list" id="ritoList"></div>
            </div>

            <div class="cal">
              <div class="cal-head">
                <div class="left">
                  <div class="h" id="calTitle">—</div>
                  <div class="p" id="calSub">—</div>
                </div>
                <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end;">
                  <button class="btn" id="btnPrev">◀</button>
                  <button class="btn" id="btnToday">Hoje</button>
                  <button class="btn" id="btnNext">▶</button>
                  <button class="btn" id="btnGcalAgenda">Google Agenda</button>
                </div>
              </div>

              <div class="cal-grid" id="calGrid"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="grid" style="grid-template-columns: 1fr;">
        <div class="card">
          <div class="hd">
            <div>
              <h2>Legenda</h2>
              <p>Previsto, Executado e execução fora da agenda (ad hoc).</p>
            </div>
            <span class="tag"><span class="dot warn"></span><span class="mono">cores</span></span>
          </div>
          <div class="bd">
            <div class="help" style="display:flex; flex-wrap:wrap; gap:10px; align-items:center;">
              <span class="chip info"><span class="dot info"></span>Previsto</span>
              <span class="chip good"><span class="dot good"></span>Executado</span>
              <span class="chip warn"><span class="dot warn"></span>Executado (ad hoc)</span>
              <span class="chip" style="opacity:.55"><span class="dot info"></span>+ Agendar</span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ============================ REPORT ============================ -->
    <section id="pageReport" aria-label="Report">
      <div class="grid">
        <section class="card" aria-label="Preenchimento">
          <div class="hd">
            <div>
              <h2>Preenchimento</h2>
              <p>Salve a ocorrência do rito. Se a data estiver prevista na Agenda, ela vira <b>Executado</b> automaticamente.</p>
            </div>
            <span class="tag"><span class="dot good"></span><span class="mono">localStorage</span></span>
          </div>

          <div class="bd">
            <div class="form">
              <div class="field">
                <label for="rite">Rito</label>
                <select id="rite"></select>
              </div>

              <div class="row">
                <div class="field">
                  <label for="date">Data de execução</label>
                  <input id="date" type="date" />
                </div>
                <div class="field">
                  <label for="owner">Responsável do rito (opcional)</label>
                  <input id="owner" type="text" placeholder="Ex.: Diretor Comercial" />
                </div>
              </div>

              <div class="row">
                <div class="field">
                  <label for="status">Status do rito</label>
                  <select id="status">
                    <option value="realizado">Realizado</option>
                    <option value="parcial">Parcial</option>
                    <option value="cancelado">Cancelado</option>
                  </select>
                </div>
                <div class="field">
                  <label for="duration">Duração (min, opcional)</label>
                  <input id="duration" type="number" min="0" step="5" placeholder="Ex.: 60" />
                </div>
              </div>

              <div class="field">
                <label for="notes">Notas do rito (opcional)</label>
                <textarea id="notes" placeholder="O que foi decidido?"></textarea>
              </div>

              <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;">
                <button class="btn primary" id="btnAdd">Salvar ocorrência</button>
                <button class="btn" id="btnGcalReport">Criar invite no Google Agenda</button>
                <div class="help" style="max-width: 380px;">
                  Dica: planeje no <b>Agenda</b> e acompanhe o cumprimento no <b>Painel</b>.
                </div>
              </div>

              <div style="margin-top:6px;">
                <table class="table" aria-label="Ocorrências do mês">
                  <thead>
                    <tr>
                      <th>Data</th>
                      <th>Rito + Encaminhamentos</th>
                      <th>Status</th>
                      <th class="right">Ações</th>
                    </tr>
                  </thead>
                  <tbody id="eventsTbody">
                    <tr><td colspan="4" class="muted">Nenhum registro ainda.</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </section>

        <section class="card" aria-label="Visualização">
          <div class="hd">
            <div>
              <h2>Visualização</h2>
              <p>Radar de encaminhamentos com prioridade para atrasados (vermelho) e edição rápida do status.</p>
            </div>
            <span class="tag"><span class="dot info"></span><span class="mono" id="monthLabel">—</span></span>
          </div>

          <div class="bd">
            <div id="tasksRadar" style="display:grid; gap:10px;"></div>
          </div>
        </section>
      </div>
    </section>

    <!-- ============================ DASHBOARD ============================ -->
    <section id="pageDash" class="hidden" aria-label="Painel">
      <div class="card" style="margin-bottom:14px;">
        <div class="hd">
          <div>
            <h2>Painel do mês</h2>
            <p>Indicadores de cumprimento do calendário e saúde dos encaminhamentos.</p>
          </div>
          <span class="tag"><span class="dot info"></span><span class="mono" id="dashMonthLabel">—</span></span>
        </div>
        <div class="bd">
          <div class="kpis" id="kpis"></div>
        </div>
      </div>

      <div class="row2">
        <div class="card">
          <div class="hd">
            <div>
              <h2>Cumprimento do calendário</h2>
              <p>% executado vs exigido (por rito e total do mês).</p>
            </div>
            <span class="tag"><span class="dot good"></span><span class="mono">% cumprimento</span></span>
          </div>
          <div class="bd">
            <div class="chartBox" id="chartCompliance"></div>
          </div>
        </div>

        <div class="card">
          <div class="hd">
            <div>
              <h2>Encaminhamentos</h2>
              <p>Total, pendentes e percentual pendente (no mês).</p>
            </div>
            <span class="tag"><span class="dot warn"></span><span class="mono">pendências</span></span>
          </div>
          <div class="bd">
            <div class="chartBox" id="chartTasks"></div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:14px;">
        <div class="hd">
          <div>
            <h2>Detalhe por rito</h2>
            <p>Exigido, previsto, executado e % de cumprimento no mês.</p>
          </div>
          <span class="tag"><span class="dot info"></span><span class="mono">tabela</span></span>
        </div>
        <div class="bd">
          <table class="table" aria-label="Detalhe por rito">
            <thead>
              <tr>
                <th>Rito</th>
                <th>Exigido</th>
                <th>Previsto</th>
                <th>Executado</th>
                <th>% Cumprimento</th>
              </tr>
            </thead>
            <tbody id="dashByRito"></tbody>
          </table>
        </div>
      </div>
    </section>

  </div>

  <div class="toast" id="toast">Ok</div>

  <script>
    /***********************
     * CONFIG: RITOS (visão semestral)
     ************************/
    const RITOS = [
      // Visualização semestral (valores de referência do semestre)
      { id: "rmr", nome: "Reunião Mensal de Resultados", categoria: "Tático", frequenciaLabel: "Mensal", minimo: 5, previsto: 6, realizadoSeed: 1 },
      { id: "forecast_comercial", nome: "Reunião de Forecast Comercial", categoria: "Tático", frequenciaLabel: "Semanal", minimo: 16, previsto: 18, realizadoSeed: 1 },
      { id: "forecast_expansao", nome: "Reunião de Forecast de Vendas e Expansão", categoria: "Tático", frequenciaLabel: "Semanal", minimo: 12, previsto: 14, realizadoSeed: 0 },
      { id: "comite_marketing", nome: "Comitê de campanhas de marketing", categoria: "Tático", frequenciaLabel: "Mensal", minimo: 5, previsto: 6, realizadoSeed: 1 },

      { id: "rev_trimestral_metas", nome: "Reunião trimestral de revisão das metas", categoria: "Estratégico", frequenciaLabel: "Trimestral", minimo: 1, previsto: 2, realizadoSeed: 0 },
      { id: "estrategia_mercado", nome: "Reunião de estratégia de mercado", categoria: "Estratégico", frequenciaLabel: "Semestral", minimo: 1, previsto: 1, realizadoSeed: 0 },
      { id: "planejamento_comercial_anual", nome: "Planejamento comercial anual", categoria: "Estratégico", frequenciaLabel: "Anual", minimo: 1, previsto: 1, realizadoSeed: 1 },
      { id: "qbr_top50", nome: "Reunião QBR com TOP50 clientes", categoria: "Estratégico", frequenciaLabel: "Semestral", minimo: 1, previsto: 2, realizadoSeed: 0 },
    ];

    const TASK_STATUSES = [
      { v:"em_andamento", label:"Em andamento" },
      { v:"concluido", label:"Concluído" },
      { v:"cancelado", label:"Cancelado" },
    ];

    const LS_EVENTS    = "ritos_report_events_v3";
    const LS_TASKS     = "ritos_report_tasks_v3";
    const LS_SCHEDULE_V1  = "ritos_schedule_v1";
    const LS_SCHEDULE  = "ritos_schedule_v2";

    const SCHED_PLANNED = "planned";
    const SCHED_DONE = "done";
    const SCHED_ADHOC_DONE = "adhoc_done";

    function loadEvents(){ try { return JSON.parse(localStorage.getItem(LS_EVENTS) || "[]"); } catch { return []; } }
    function saveEvents(arr){ localStorage.setItem(LS_EVENTS, JSON.stringify(arr)); }
    function loadTasks(){ try { return JSON.parse(localStorage.getItem(LS_TASKS) || "[]"); } catch { return []; } }
    function saveTasks(arr){ localStorage.setItem(LS_TASKS, JSON.stringify(arr)); }

    function migrateSchedule(){
      const v2 = localStorage.getItem(LS_SCHEDULE);
      if (v2) return;
      const v1 = localStorage.getItem(LS_SCHEDULE_V1);
      if (!v1) return;
      try{
        const oldArr = JSON.parse(v1 || "[]");
        const migrated = (Array.isArray(oldArr) ? oldArr : []).map(s=>({
          id: s.id || uid(),
          ritoId: s.ritoId,
          date: s.date,
          state: SCHED_PLANNED,
          eventId: null,
          createdAt: s.createdAt || new Date().toISOString(),
          updatedAt: new Date().toISOString()
        }));
        localStorage.setItem(LS_SCHEDULE, JSON.stringify(migrated));
      }catch{}
    }

    function loadSchedule(){
      migrateSchedule();
      try {
        const arr = JSON.parse(localStorage.getItem(LS_SCHEDULE) || "[]");
        return (Array.isArray(arr)?arr:[]).map(s=>({
          id: s.id || uid(),
          ritoId: s.ritoId,
          date: s.date,
          state: s.state || SCHED_PLANNED,
          eventId: (s.eventId ?? null),
          createdAt: s.createdAt || new Date().toISOString(),
          updatedAt: s.updatedAt || new Date().toISOString()
        }));
      } catch { return []; }
    }
    function saveSchedule(arr){ localStorage.setItem(LS_SCHEDULE, JSON.stringify(arr)); }

    function pad2(n){ return String(n).padStart(2,"0"); }
    function uid(){ return (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random().toString(16).slice(2)); }

    function todayISO(){
      const d = new Date();
      return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    }
    function monthISO(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}`; }
    function fmtDateBR(iso){
      if(!iso) return "—";
      const [y,m,dd] = iso.split("-").map(Number);
      const d = new Date(y, m-1, dd);
      return `${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()}`;
    }
    function monthLabel(yyyyMM){
      const [y,m] = yyyyMM.split("-").map(Number);
      const names = ["janeiro","fevereiro","março","abril","maio","junho","julho","agosto","setembro","outubro","novembro","dezembro"];
      return `${names[m-1]} de ${y}`;
    }


// ------------------ Google Agenda (link de criação rápida) ------------------
function addOneDayISO(iso){
  const [y,m,d] = iso.split("-").map(Number);
  const dt = new Date(y, m-1, d);
  dt.setDate(dt.getDate() + 1);
  return `${dt.getFullYear()}-${pad2(dt.getMonth()+1)}-${pad2(dt.getDate())}`;
}
function openGoogleCalendarInvite({ title, isoDate, details }){
  if (!title || !isoDate) return;
  // Evento "dia inteiro" para evitar problemas de fuso horário. (fim = dia seguinte)
  const start = isoDate.replace(/-/g, "");
  const end = addOneDayISO(isoDate).replace(/-/g, "");
  const url =
    "https://calendar.google.com/calendar/render?action=TEMPLATE" +
    `&text=${encodeURIComponent(title)}` +
    `&dates=${encodeURIComponent(start + "/" + end)}` +
    `&details=${encodeURIComponent(details || "")}`;
  window.open(url, "_blank");
}


    function semesterRange(yyyyMM){
      const [y,m] = yyyyMM.split("-").map(Number);
      const isH1 = m <= 6;
      const startM = isH1 ? 1 : 7;
      const endMExclusive = isH1 ? 7 : 13;
      const start = `${y}-${pad2(startM)}-01`;
      const end = `${y}-${pad2(endMExclusive)}-01`; // exclusivo
      return { start, end, label: isH1 ? `1º semestre de ${y}` : `2º semestre de ${y}` };
    }
    function inRangeISO(iso, startInclusive, endExclusive){
      return iso >= startInclusive && iso < endExclusive;
    }
    function scheduleForSemester(yyyyMM){
      const {start, end} = semesterRange(yyyyMM);
      return loadSchedule().filter(s=>inRangeISO(s.date, start, end));
    }
    function eventsForSemester(yyyyMM){
      const {start, end} = semesterRange(yyyyMM);
      return loadEvents().filter(e=>inRangeISO(e.date, start, end) && e.status !== "cancelado");
    }
    function isOverdue(dueISO){
      if (!dueISO) return false;
      const today = new Date();
      const [y,m,d] = dueISO.split("-").map(Number);
      const due = new Date(y, m-1, d, 23,59,59);
      return due.getTime() < today.getTime();
    }

    function toastShow(msg){
      const t = document.getElementById("toast");
      t.textContent = msg;
      t.classList.add("show");
      setTimeout(()=>t.classList.remove("show"), 1600);
    }

    function escapeHtml(s){
      return (s||"").replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[c]));
    }
    function escapeAttr(s){ return escapeHtml(s).replace(/`/g,"&#096;"); }

    function requiredForMonth(rito){
      // Mantido o nome por compatibilidade, mas agora é exigência do SEMESTRE.
      return Math.max(0, Math.round(rito.minimo || 0));
    }

    function badgeForTask(task){
      if (task.status !== "concluido" && task.status !== "cancelado" && isOverdue(task.prazo)){
        return { cls:"bad", label:"Atrasado", dot:"bad" };
      }
      if (task.status === "concluido") return { cls:"good", label:"Concluído", dot:"good" };
      if (task.status === "cancelado") return { cls:"neutral", label:"Cancelado", dot:"info" };
      return { cls:"info", label:"Em andamento", dot:"info" };
    }

    function patchTask(taskId, patch){
      const tasks = loadTasks();
      const idx = tasks.findIndex(t=>t.id === taskId);
      if (idx < 0) return;
      tasks[idx] = { ...tasks[idx], ...patch, updatedAt: new Date().toISOString() };
      saveTasks(tasks);
    }

    function addTask(eventId, payload){
      const tasks = loadTasks();
      tasks.push({
        id: uid(),
        eventId,
        encaminhamento: payload.encaminhamento.trim(),
        prazo: payload.prazo || "",
        responsavel: (payload.responsavel || "").trim(),
        status: payload.status || "em_andamento",
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      });
      saveTasks(tasks);
    }

    function deleteTask(taskId){
      saveTasks(loadTasks().filter(t=>t.id !== taskId));
      toastShow("Encaminhamento removido.");
      renderAll();
    }

    function scheduleForMonth(yyyyMM){
      return loadSchedule().filter(s=>s.date.startsWith(yyyyMM));
    }

    function getScheduleItem(ritoId, isoDate){
      const all = loadSchedule();
      return all.find(s=>s.ritoId === ritoId && s.date === isoDate) || null;
    }

    function upsertScheduleItem(item){
      const all = loadSchedule();
      const idx = all.findIndex(s=>s.id === item.id);
      if (idx >= 0) all[idx] = { ...all[idx], ...item, updatedAt: new Date().toISOString() };
      else all.push({ ...item, updatedAt: new Date().toISOString() });
      saveSchedule(all);
    }

    function removeScheduleItem(ritoId, isoDate){
      const all = loadSchedule();
      const next = all.filter(s=>!(s.ritoId===ritoId && s.date===isoDate));
      saveSchedule(next);
    }

    function togglePlanned(ritoId, isoDate){
      const item = getScheduleItem(ritoId, isoDate);
      if (!item){
        upsertScheduleItem({ id: uid(), ritoId, date: isoDate, state: SCHED_PLANNED, eventId: null, createdAt: new Date().toISOString() });
        toastShow("Previsto agendado.");
        return;
      }
      if (item.state === SCHED_DONE || item.state === SCHED_ADHOC_DONE){
        toastShow("Já está Executado. Para desfazer, exclua a ocorrência no Report.");
        return;
      }
      removeScheduleItem(ritoId, isoDate);
      toastShow("Previsto removido.");
    }

    function markExecutedFromReport(event){
      const all = loadSchedule();
      const idx = all.findIndex(s=>s.ritoId===event.ritoId && s.date===event.date);
      if (idx >= 0){
        all[idx] = { ...all[idx], state: SCHED_DONE, eventId: event.id, updatedAt: new Date().toISOString() };
      } else {
        all.push({
          id: uid(),
          ritoId: event.ritoId,
          date: event.date,
          state: SCHED_ADHOC_DONE,
          eventId: event.id,
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString()
        });
      }
      saveSchedule(all);
    }

    function unmarkExecutedFromReport(eventId){
      const all = loadSchedule();
      let changed = false;
      const next = all.map(s=>{
        if (s.eventId !== eventId) return s;
        changed = true;
        if (s.state === SCHED_ADHOC_DONE){
          return null;
        }
        return { ...s, state: SCHED_PLANNED, eventId: null, updatedAt: new Date().toISOString() };
      }).filter(Boolean);
      if (changed) saveSchedule(next);
    }

    function addEvent(){
      const ritoId = document.getElementById("rite").value;
      const date = document.getElementById("date").value;
      if (!ritoId || !date){ toastShow("Preencha rito e data."); return; }

      const events = loadEvents();
      const ev = {
        id: uid(),
        ritoId,
        date,
        owner: (document.getElementById("owner").value || "").trim(),
        status: document.getElementById("status").value,
        durationMin: document.getElementById("duration").value ? Number(document.getElementById("duration").value) : null,
        notes: (document.getElementById("notes").value || "").trim(),
        createdAt: new Date().toISOString()
      };
      events.push(ev);
      saveEvents(events);

      if (ev.status !== "cancelado") markExecutedFromReport(ev);

      document.getElementById("owner").value = "";
      document.getElementById("status").value = "realizado";
      document.getElementById("duration").value = "";
      document.getElementById("notes").value = "";

      toastShow("Ocorrência salva e agenda atualizada.");
      renderAll();
    }

    function deleteEvent(id){
      const ev = loadEvents().find(e=>e.id===id);
      saveEvents(loadEvents().filter(e=>e.id !== id));
      saveTasks(loadTasks().filter(t=>t.eventId !== id));
      if (ev) unmarkExecutedFromReport(id);
      toastShow("Rito removido (e agenda/encaminhamentos atualizados).");
      renderAll();
    }

    function clearAll(){
      localStorage.removeItem(LS_EVENTS);
      localStorage.removeItem(LS_TASKS);
      localStorage.removeItem(LS_SCHEDULE);
      localStorage.removeItem(LS_SCHEDULE_V1);
      toastShow("Dados zerados.");
      renderAll();
    }

    function loadDemo(){
      const m = document.getElementById("month").value;

      const all = loadSchedule();
      const days = [5,12,19,26];
      days.forEach(d=>{
        const iso = `${m}-${pad2(d)}`;
        if (!all.some(s=>s.ritoId==="forecast_comercial" && s.date===iso)){
          all.push({ id: uid(), ritoId:"forecast_comercial", date: iso, state: SCHED_PLANNED, eventId:null, createdAt:new Date().toISOString(), updatedAt:new Date().toISOString() });
        }
      });
      saveSchedule(all);

      const events = loadEvents();
      const tasks = loadTasks();
      const ev = { id: uid(), ritoId:"rmr", date:`${m}-07`, owner:"Victor", status:"realizado", durationMin:60, notes:"RMR do mês", createdAt:new Date().toISOString() };
      events.push(ev);
      saveEvents(events);
      markExecutedFromReport(ev);

      tasks.push(
        { id: uid(), eventId: ev.id, encaminhamento:"Revisar carteira", prazo:`${m}-05`, responsavel:"João", status:"em_andamento", createdAt:new Date().toISOString(), updatedAt:new Date().toISOString() },
        { id: uid(), eventId: ev.id, encaminhamento:"Plano de ação contas críticas", prazo:`${m}-18`, responsavel:"Maria", status:"em_andamento", createdAt:new Date().toISOString(), updatedAt:new Date().toISOString() }
      );
      saveTasks(tasks);

      toastShow("Exemplo carregado.");
      renderAll();
    }

    function renderReport(){
      const m = document.getElementById("month").value;
      document.getElementById("monthLabel").textContent = monthLabel(m);

      const events = loadEvents().filter(e=>e.date.startsWith(m)).sort((a,b)=>b.date.localeCompare(a.date));
      const tasksAll = loadTasks();
      const tasksMonth = tasksAll.filter(t => events.some(e=>e.id === t.eventId));

      const tbody = document.getElementById("eventsTbody");
      if(events.length === 0){
        tbody.innerHTML = `<tr><td colspan="4" class="muted">Nenhum registro ainda.</td></tr>`;
      } else {
        tbody.innerHTML = events.map(e=>{
          const r = RITOS.find(x=>x.id===e.ritoId);
          const evTasks = tasksMonth.filter(t=>t.eventId === e.id);
          const open = evTasks.filter(t=>t.status!=="concluido" && t.status!=="cancelado").length;
          const overdue = evTasks.filter(t=>t.status!=="concluido" && t.status!=="cancelado" && isOverdue(t.prazo)).length;
          const ritoDot = e.status==="realizado" ? "good" : (e.status==="parcial"?"warn":"bad");

          return `
            <tr>
              <td class="mono">${fmtDateBR(e.date)}</td>
              <td>
                <div style="font-weight:650">${r ? escapeHtml(r.nome) : escapeHtml(e.ritoId)}</div>
                <div class="muted" style="font-size:11.5px;">
                  ${r ? `${escapeHtml(r.categoria)} • ${escapeHtml(r.frequenciaLabel)}` : ""}
                  ${e.owner ? ` • Resp. rito: <span class="mono">${escapeHtml(e.owner)}</span>` : ""}
                </div>

                <details>
                  <summary>
                    <div class="sum-left">
                      <div class="t">Encaminhamentos</div>
                      <div class="s">Edite responsável e status a qualquer momento (salva automático).</div>
                    </div>
                    <div class="sum-right">
                      <span class="badge ${overdue>0 ? "bad" : (open>0 ? "info" : "good")}">
                        <span class="dot ${overdue>0 ? "bad" : (open>0 ? "info" : "good")}"></span>
                        ${overdue>0 ? `${overdue} atras.` : (open>0 ? `${open} abertos` : "sem pendências")}
                      </span>
                      <span class="tag"><span class="dot ${ritoDot}"></span>${escapeHtml(e.status)}</span>
                    </div>
                  </summary>

                  <div class="task-list">
                    <div class="task-row">
                      <div class="field" style="margin:0;">
                        <label>Encaminhamento</label>
                        <input id="new_enc_${e.id}" type="text" placeholder="Ex.: Revisar carteira TOP20 e definir ações" />
                      </div>
                      <div class="field" style="margin:0;">
                        <label>Prazo</label>
                        <input id="new_prazo_${e.id}" type="date" />
                      </div>
                      <div class="field" style="margin:0;">
                        <label>Responsável</label>
                        <input id="new_resp_${e.id}" type="text" placeholder="Nome / função" />
                      </div>
                      <div class="field" style="margin:0;">
                        <label>Status</label>
                        <select id="new_status_${e.id}">
                          ${TASK_STATUSES.map(s=>`<option value="${s.v}">${s.label}</option>`).join("")}
                        </select>
                      </div>
                    </div>

                    <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:space-between; align-items:center;">
                      <button class="btn primary" style="padding:8px 12px;" onclick="addTaskUI('${e.id}')">Adicionar encaminhamento</button>
                      <div class="help">Se o prazo passou e não está concluído/cancelado, vira <span class="mono">Atrasado</span>.</div>
                    </div>

                    <div style="display:grid; gap:10px;">
                      ${evTasks.length===0 ? `<div class="muted" style="font-size:12.5px;">Nenhum encaminhamento registrado ainda.</div>` : ""}
                      ${evTasks.map(t=>{
                        const b = badgeForTask(t);
                        return `
                          <div class="task">
                            <div class="grid4">
                              <div class="field" style="margin:0;">
                                <label>Encaminhamento</label>
                                <input value="${escapeAttr(t.encaminhamento)}"
                                       onchange="onTaskEdit('${t.id}', 'encaminhamento', this.value)" />
                              </div>
                              <div class="field" style="margin:0;">
                                <label>Prazo</label>
                                <input type="date" value="${escapeAttr(t.prazo || "")}"
                                       onchange="onTaskEdit('${t.id}', 'prazo', this.value)" />
                              </div>
                              <div class="field" style="margin:0;">
                                <label>Responsável</label>
                                <input value="${escapeAttr(t.responsavel || "")}"
                                       onchange="onTaskEdit('${t.id}', 'responsavel', this.value)" />
                              </div>
                              <div class="field" style="margin:0;">
                                <label>Status</label>
                                <select onchange="onTaskEdit('${t.id}', 'status', this.value)">
                                  ${TASK_STATUSES.map(s=>`<option value="${s.v}" ${s.v===t.status?"selected":""}>${s.label}</option>`).join("")}
                                </select>
                              </div>
                            </div>

                            <div class="task-actions">
                              <span class="badge ${b.cls}"><span class="dot ${b.dot}"></span>${b.label}</span>
                              <button class="tiny-btn" onclick="delTaskUI('${t.id}')">Excluir</button>
                            </div>
                          </div>
                        `;
                      }).join("")}
                    </div>
                  </div>
                </details>
              </td>
              <td><span class="tag"><span class="dot ${ritoDot}"></span>${escapeHtml(e.status)}</span></td>
              <td class="right"><button class="btn" style="padding:7px 10px; font-size:12px" onclick="delEventUI('${e.id}')">Excluir</button></td>
            </tr>
          `;
        }).join("");
      }

      const radar = document.getElementById("tasksRadar");
      if(tasksMonth.length === 0){
        radar.innerHTML = `<div class="badge good"><span class="dot good"></span>Sem encaminhamentos no mês</div>`;
      } else {
        const sorted = [...tasksMonth].sort((a,b)=>{
          const ao = (a.status!=="concluido" && a.status!=="cancelado" && isOverdue(a.prazo)) ? 1 : 0;
          const bo = (b.status!=="concluido" && b.status!=="cancelado" && isOverdue(b.prazo)) ? 1 : 0;
          if(ao !== bo) return bo-ao;
          return (a.prazo||"9999-99-99").localeCompare(b.prazo||"9999-99-99");
        }).slice(0,10);

        radar.innerHTML = sorted.map(t=>{
          const b = badgeForTask(t);
          const ev = events.find(e=>e.id===t.eventId);
          const r = ev ? RITOS.find(x=>x.id===ev.ritoId) : null;

          return `
            <div class="task">
              <div style="font-weight:650">${escapeHtml(t.encaminhamento)}</div>
              <div class="task-actions" style="justify-content:space-between;">
                <div style="display:flex; flex-wrap:wrap; gap:8px; align-items:center;">
                  <span class="tag"><span class="dot"></span>Prazo: <span class="mono">${fmtDateBR(t.prazo)}</span></span>
                  <span class="tag"><span class="dot"></span>Resp.: <span class="mono">${escapeHtml(t.responsavel || "—")}</span></span>
                  <span class="badge ${b.cls}"><span class="dot ${b.dot}"></span>${b.label}</span>
                  ${r && ev ? `<span class="tag"><span class="dot"></span>${escapeHtml(r.nome)} • <span class="mono">${fmtDateBR(ev.date)}</span></span>` : ""}
                </div>
                <select class="tiny-btn" onchange="onTaskEdit('${t.id}','status', this.value)">
                  ${TASK_STATUSES.map(s=>`<option value="${s.v}" ${s.v===t.status?"selected":""}>${s.label}</option>`).join("")}
                </select>
              </div>
            </div>
          `;
        }).join("");
      }
    }

    let agendaSelectedRitoId = RITOS[0]?.id || "";
    let agendaSelectedISODate = "";

    function ritoAgendaBadge(done, required){
      if (required === 0){ return { cls:"neutral", label:"Sem exigência", dot:"info" }; }
      if (done === required) return { cls:"good", label:`Completo ${done}/${required}`, dot:"good" };
      if (done > required) return { cls:"info", label:`Excedeu ${done}/${required}`, dot:"info" };
      if (done === 0) return { cls:"bad", label:`Faltando ${done}/${required}`, dot:"bad" };
      return { cls:"warn", label:`Parcial ${done}/${required}`, dot:"warn" };
    }

    function renderAgenda(){
      const m = document.getElementById("month").value;
      const schedule = scheduleForSemester(m);

      const sel = document.getElementById("agendaRite");
      sel.innerHTML = RITOS.map(r=>`<option value="${r.id}">${escapeHtml(r.nome)} • ${escapeHtml(r.frequenciaLabel)}</option>`).join("");
      sel.value = agendaSelectedRitoId || RITOS[0]?.id || "";

      const list = document.getElementById("ritoList");
      list.innerHTML = RITOS.map(r=>{
        const req = requiredForMonth(r);
        const items = schedule.filter(s=>s.ritoId===r.id);
        const planned = Math.max(0, Math.round(r.previsto || 0));
        const done = Math.max(0, Math.round(r.realizadoSeed || 0)) + items.filter(x=>x.state===SCHED_DONE || x.state===SCHED_ADHOC_DONE).length;
        const b = ritoAgendaBadge(done, req);
        const pctDone = (req>0) ? Math.min(100, Math.round((done/req)*100)) : (done>0?100:0);
        const active = (r.id === agendaSelectedRitoId) ? "active" : "";
        return `
          <div class="rito-item ${active}" onclick="selectAgendaRito('${r.id}')">
            <div>
              <div class="t">${escapeHtml(r.nome)}</div>
              <div class="s">${escapeHtml(r.categoria)} • ${escapeHtml(r.frequenciaLabel)} • Exigido: <span class="mono">${req}</span> • Previsto: <span class="mono">${planned}</span></div>
            </div>
            <div class="rightCol">
              <span class="badge ${b.cls}"><span class="dot ${b.dot}"></span>${b.label}</span>
              <div class="bar"><div style="width:${pctDone}%;"></div></div>
            </div>
          </div>
        `;
      }).join("");

      const rito = RITOS.find(x=>x.id===agendaSelectedRitoId) || RITOS[0];
      if (!rito) return;

      const req = requiredForMonth(rito);
      const items = schedule.filter(s=>s.ritoId===rito.id);
      const planned = Math.max(0, Math.round(rito.previsto || 0));
      const done = Math.max(0, Math.round(rito.realizadoSeed || 0)) + items.filter(x=>x.state===SCHED_DONE || x.state===SCHED_ADHOC_DONE).length;
      const b = ritoAgendaBadge(done, req);

      document.getElementById("agendaHint").innerHTML = `
        <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
          <span class="badge ${b.cls}"><span class="dot ${b.dot}"></span>${escapeHtml(rito.nome)} • ${b.label}</span>
          <span class="tag"><span class="dot info"></span>Previsto: <span class="mono">${planned}</span></span>
          <span class="tag"><span class="dot good"></span>Executado: <span class="mono">${done}</span></span>
        </div>
      `;

      document.getElementById("calTitle").textContent = `${rito.nome} — ${monthLabel(m)}`;
      document.getElementById("calSub").textContent = (req>0)
        ? `Exigido: ${req} • Previsto: ${planned} • Executado: ${done} • Clique no dia para marcar/remover previsto`
        : `Sem exigência automática neste mês (ajuste a regra se quiser exigir).`;

      const grid = document.getElementById("calGrid");
      const dows = ["Seg","Ter","Qua","Qui","Sex","Sáb","Dom"];
      const today = todayISO();

      const [y,mm] = m.split("-").map(Number);
      const first = new Date(y, mm-1, 1);
      const daysInMonth = new Date(y, mm, 0).getDate();
      const firstDowMon0 = (first.getDay() + 6) % 7;

      const itemsSelected = new Map(items.map(x=>[x.date, x]));
      let html = "";
      dows.forEach(d=>{ html += `<div class="dow">${d}</div>`; });

      const totalCells = 42;
      for (let i=0;i<totalCells;i++){
        const dayNum = i - firstDowMon0 + 1;
        const inMonth = dayNum >= 1 && dayNum <= daysInMonth;
        const iso = inMonth ? `${m}-${pad2(dayNum)}` : "";
        const isToday = inMonth && iso === today;

        let dots = "";
        if (inMonth){
          const dayItems = schedule.filter(s=>s.date===iso);
          const ids = Array.from(new Set(dayItems.map(x=>x.ritoId))).slice(0, 8);
          if (ids.length>0){
            dots = `<div class="stack">` + ids.map(rid=>{
              const state = dayItems.find(x=>x.ritoId===rid)?.state || SCHED_PLANNED;
              const cls = (state===SCHED_DONE || state===SCHED_ADHOC_DONE) ? "good" : "info";
              return `<span class="miniDot ${cls}"></span>`;
            }).join("") + `</div>`;
          }
        }

        const item = inMonth ? itemsSelected.get(iso) : null;
        let chip = "";
        if (inMonth && item){
          if (item.state === SCHED_DONE){
            chip = `<div class="chip good"><span class="dot good"></span>Executado</div>`;
          } else if (item.state === SCHED_ADHOC_DONE){
            chip = `<div class="chip warn"><span class="dot warn"></span>Exec. (ad hoc)</div>`;
          } else {
            chip = `<div class="chip info"><span class="dot info"></span>Previsto <span class="x">✕</span></div>`;
          }
        } else if (inMonth){
          chip = `<div class="chip" style="opacity:.55"><span class="dot info"></span>+ Agendar</div>`;
        }

        const cellCls = ["cell", (!inMonth?"muted":""), (isToday?"today":"")].filter(Boolean).join(" ");
        html += `
          <div class="${cellCls}" ${inMonth ? `onclick="onCalendarClick('${iso}')"` : ""}>
            <div class="day">${inMonth ? dayNum : ""}</div>
            ${inMonth ? chip : ""}
            ${dots}
          </div>
        `;
      }

      grid.innerHTML = html;

      sel.onchange = (e)=>{
        agendaSelectedRitoId = e.target.value;
        renderAll();
      };
    }

    function selectAgendaRito(ritoId){
      agendaSelectedRitoId = ritoId;
      renderAll();
    }

    function onCalendarClick(isoDate){
      agendaSelectedISODate = isoDate;
      const rito = RITOS.find(x=>x.id===agendaSelectedRitoId);
      if (!rito) return;
      togglePlanned(rito.id, isoDate);
      renderAll();
    }

    function shiftMonth(delta){
      const [y,m] = document.getElementById("month").value.split("-").map(Number);
      const d = new Date(y, m-1, 1);
      d.setMonth(d.getMonth() + delta);
      document.getElementById("month").value = monthISO(d);
      renderAll();
    }

    function pct(a,b){
      if (b<=0) return 0;
      return Math.max(0, Math.min(100, Math.round((a/b)*100)));
    }

    function donutSVG(percent, color){
      const r = 38;
      const c = 2 * Math.PI * r;
      const p = Math.max(0, Math.min(100, percent));
      const dash = (p/100) * c;
      return `
        <svg width="120" height="120" viewBox="0 0 120 120" aria-label="donut">
          <circle cx="60" cy="60" r="${r}" stroke="rgba(255,255,255,.10)" stroke-width="12" fill="none" />
          <circle cx="60" cy="60" r="${r}" stroke="${color}" stroke-width="12" fill="none"
                  stroke-linecap="round" transform="rotate(-90 60 60)"
                  stroke-dasharray="${dash} ${c-dash}" />
          <text x="60" y="64" text-anchor="middle" font-size="18" font-weight="800" fill="rgba(255,255,255,.92)">${p}%</text>
        </svg>
      `;
    }

    function barsByRito(data){
      const rows = data.map(d=>{
        const w = Math.max(0, Math.min(100, d.pct));
        const cls = d.pct>=100 ? "good" : (d.pct>=50 ? "warn" : "bad");
        const color = cls==="good" ? "rgba(43,228,167,.85)" : (cls==="warn" ? "rgba(255,204,102,.85)" : "rgba(255,92,122,.85)");
        return `
          <div style="display:grid; grid-template-columns: 1.2fr 2fr; gap:10px; align-items:center; margin:10px 0;">
            <div style="font-size:12.5px;">
              <div style="font-weight:700">${escapeHtml(d.name)}</div>
              <div class="muted" style="font-size:11.5px;">${d.done}/${d.req} • ${d.pct}%</div>
            </div>
            <div style="height:12px; border-radius:999px; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.10); overflow:hidden;">
              <div style="height:100%; width:${w}%; background:${color}; border-radius:999px;"></div>
            </div>
          </div>
        `;
      }).join("");
      return `<div>${rows}</div>`;
    }

    function computeMonthStats(yyyyMM){
      // Mantido o nome por compatibilidade, mas calcula o SEMESTRE.
      const schedule = scheduleForSemester(yyyyMM);
      const events = eventsForSemester(yyyyMM);
      const tasks = loadTasks();
      const tasksMonth = tasks.filter(t => events.some(e=>e.id === t.eventId));

      const tasksTotal = tasksMonth.length;
      const tasksPending = tasksMonth.filter(t=>t.status!=="concluido" && t.status!=="cancelado").length;
      const tasksPendingPct = tasksTotal>0 ? Math.round((tasksPending/tasksTotal)*100) : 0;

      const byRito = RITOS.map(r=>{
        const req = requiredForMonth(r);
        const items = schedule.filter(s=>s.ritoId===r.id);
        const planned = Math.max(0, Math.round(r.previsto || 0));
        const done = Math.max(0, Math.round(r.realizadoSeed || 0)) + items.filter(x=>x.state===SCHED_DONE || x.state===SCHED_ADHOC_DONE).length;
        const p = req>0 ? pct(done, req) : (done>0?100:0);
        return { ritoId:r.id, name:r.nome, req, planned, done, pct:p };
      });

      const requiredTotal = byRito.reduce((a,b)=>a+(b.req||0),0);
      const doneTotal = byRito.reduce((a,b)=>a+(b.done||0),0);
      const compliancePct = requiredTotal>0 ? pct(doneTotal, requiredTotal) : (doneTotal>0?100:0);

      return {
        requiredTotal,
        doneTotal,
        compliancePct,
        meetingsDone: events.length,
        tasksTotal,
        tasksPending,
        tasksPendingPct,
        byRito
      };
    }

    function renderDash(){
      const m = document.getElementById("month").value;
      const sem = semesterRange(m);
      document.getElementById("dashMonthLabel").textContent = sem.label;
      const st = computeMonthStats(m);

      const kpis = document.getElementById("kpis");
      kpis.innerHTML = `
        <div class="kpi">
          <div class="t">Cumprimento do calendário</div>
          <div class="v">${st.compliancePct}%</div>
          <div class="s">Executado ${st.doneTotal} / Exigido ${st.requiredTotal}</div>
        </div>
        <div class="kpi">
          <div class="t">Reuniões executadas</div>
          <div class="v">${st.meetingsDone}</div>
          <div class="s">No Report (semestre, exceto canceladas)</div>
        </div>
        <div class="kpi">
          <div class="t">Encaminhamentos registrados</div>
          <div class="v">${st.tasksTotal}</div>
          <div class="s">Vinculados a reuniões do semestre</div>
        </div>
        <div class="kpi">
          <div class="t">Encaminhamentos pendentes</div>
          <div class="v">${st.tasksPending} <span class="muted" style="font-size:12.5px;">(${st.tasksPendingPct}%)</span></div>
          <div class="s">Em andamento (não concluído/cancelado)</div>
        </div>
      `;

      const c1 = document.getElementById("chartCompliance");
      c1.innerHTML = `
        <div style="display:flex; gap:14px; flex-wrap:wrap; align-items:center; justify-content:space-between;">
          <div>
            <div class="badge ${st.compliancePct>=100?"good":(st.compliancePct>=50?"warn":"bad")}">
              <span class="dot ${st.compliancePct>=100?"good":(st.compliancePct>=50?"warn":"bad")}"></span>
              ${st.compliancePct}% no semestre
            </div>
            <div class="help" style="margin-top:8px;">Base: soma do <b>Exigido</b> por rito. Execuções ad hoc contam como executadas.</div>
          </div>
          <div>${donutSVG(st.compliancePct, st.compliancePct>=100?"rgba(43,228,167,.9)":(st.compliancePct>=50?"rgba(255,204,102,.9)":"rgba(255,92,122,.9)"))}</div>
        </div>
        <div style="margin-top:12px;">
          ${barsByRito(st.byRito.filter(x=>x.req>0).map(x=>({name:x.name, pct:x.pct, done:x.done, req:x.req})))}
        </div>
      `;

      const c2 = document.getElementById("chartTasks");
      const pendingColor = st.tasksPendingPct<=20 ? "rgba(43,228,167,.9)" : (st.tasksPendingPct<=50 ? "rgba(255,204,102,.9)" : "rgba(255,92,122,.9)");
      c2.innerHTML = `
        <div style="display:flex; gap:14px; flex-wrap:wrap; align-items:center; justify-content:space-between;">
          <div>
            <div class="badge ${st.tasksPendingPct<=20?"good":(st.tasksPendingPct<=50?"warn":"bad")}">
              <span class="dot ${st.tasksPendingPct<=20?"good":(st.tasksPendingPct<=50?"warn":"bad")}"></span>
              ${st.tasksPendingPct}% pendente
            </div>
            <div class="help" style="margin-top:8px;">Pendentes: status diferente de concluído/cancelado.</div>
            <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;">
              <span class="tag"><span class="dot"></span>Total: <span class="mono">${st.tasksTotal}</span></span>
              <span class="tag"><span class="dot"></span>Pendentes: <span class="mono">${st.tasksPending}</span></span>
            </div>
          </div>
          <div>${donutSVG(st.tasksPendingPct, pendingColor)}</div>
        </div>
      `;

      const tb = document.getElementById("dashByRito");
      tb.innerHTML = st.byRito.map(r=>{
        const cls = r.pct>=100?"good":(r.pct>=50?"warn":"bad");
        return `
          <tr>
            <td>${escapeHtml(r.name)}</td>
            <td class="mono">${r.req}</td>
            <td class="mono">${r.planned}</td>
            <td class="mono">${r.done}</td>
            <td><span class="badge ${cls}"><span class="dot ${cls}"></span>${r.pct}%</span></td>
          </tr>
        `;
      }).join("");
    }

    function addTaskUI(eventId){
      const enc = document.getElementById(`new_enc_${eventId}`).value || "";
      const prazo = document.getElementById(`new_prazo_${eventId}`).value || "";
      const resp = document.getElementById(`new_resp_${eventId}`).value || "";
      const st = document.getElementById(`new_status_${eventId}`).value || "em_andamento";
      if(!enc.trim()){ toastShow("Preencha o Encaminhamento."); return; }
      addTask(eventId, {encaminhamento:enc, prazo, responsavel:resp, status:st});
      document.getElementById(`new_enc_${eventId}`).value = "";
      document.getElementById(`new_prazo_${eventId}`).value = "";
      document.getElementById(`new_resp_${eventId}`).value = "";
      document.getElementById(`new_status_${eventId}`).value = "em_andamento";
      toastShow("Encaminhamento adicionado.");
      renderAll();
    }

    function onTaskEdit(taskId, field, value){
      patchTask(taskId, {[field]: value});
      toastShow("Alteração salva.");
      renderAll();
    }

    function delTaskUI(taskId){ deleteTask(taskId); }
    function delEventUI(eventId){ deleteEvent(eventId); }

    function renderAll(){
      renderAgenda();
      renderReport();
      renderDash();
    }

    function setPage(which){
      const report = document.getElementById("pageReport");
      const agenda = document.getElementById("pageAgenda");
      const dash = document.getElementById("pageDash");
      const tR = document.getElementById("tabReport");
      const tA = document.getElementById("tabAgenda");
      const tD = document.getElementById("tabDash");

      report.classList.add("hidden");
      agenda.classList.add("hidden");
      dash.classList.add("hidden");
      tR.classList.remove("active");
      tA.classList.remove("active");
      tD.classList.remove("active");

      if (which === "agenda"){
        agenda.classList.remove("hidden");
        tA.classList.add("active");
      } else if (which === "dash"){
        dash.classList.remove("hidden");
        tD.classList.add("active");
      } else {
        report.classList.remove("hidden");
        tR.classList.add("active");
      }
    }

    function init(){
      const now = new Date();
      document.getElementById("month").value = monthISO(now);
      document.getElementById("date").value = todayISO();

      document.getElementById("rite").innerHTML = RITOS.map(r=>`<option value="${r.id}">${escapeHtml(r.nome)} • ${escapeHtml(r.categoria)}</option>`).join("");
      document.getElementById("agendaRite").innerHTML = RITOS.map(r=>`<option value="${r.id}">${escapeHtml(r.nome)} • ${escapeHtml(r.frequenciaLabel)}</option>`).join("");

      agendaSelectedRitoId = RITOS[0]?.id || "";

      document.getElementById("tabReport").addEventListener("click", ()=>setPage("report"));
      document.getElementById("tabAgenda").addEventListener("click", ()=>setPage("agenda"));
      document.getElementById("tabDash").addEventListener("click", ()=>setPage("dash"));
      document.getElementById("tabReport").classList.add("active");

      document.getElementById("btnAdd").addEventListener("click", addEvent);

      // Criar invite no Google Agenda (pré-preenchido)
      document.getElementById("btnGcalReport").addEventListener("click", ()=>{
        const ritoId = document.getElementById("rite").value;
        const date = document.getElementById("date").value;
        const rito = RITOS.find(r=>r.id===ritoId);
        if (!ritoId || !date || !rito){ toastShow("Selecione rito e data."); return; }
        const owner = (document.getElementById("owner").value || "").trim();
        const notes = (document.getElementById("notes").value || "").trim();
        const details = `Modelo de Gestão — ${rito.categoria} • ${rito.frequenciaLabel}` +
                        (owner ? `
Responsável: ${owner}` : "") +
                        (notes ? `

Notas:
${notes}` : "");
        openGoogleCalendarInvite({ title: rito.nome, isoDate: date, details });
      });

      document.getElementById("btnGcalAgenda").addEventListener("click", ()=>{
        const rito = RITOS.find(r=>r.id===agendaSelectedRitoId);
        if (!rito){ toastShow("Selecione um rito."); return; }
        if (!agendaSelectedISODate){ toastShow("Clique em um dia no calendário."); return; }
        const details = `Modelo de Gestão — ${rito.categoria} • ${rito.frequenciaLabel}`;
        openGoogleCalendarInvite({ title: rito.nome, isoDate: agendaSelectedISODate, details });
      });
      document.getElementById("btnClear").addEventListener("click", ()=>{
        if(confirm("Tem certeza que deseja apagar TODOS os registros, encaminhamentos e agenda?")) clearAll();
      });
      document.getElementById("btnDemo").addEventListener("click", loadDemo);
      document.getElementById("month").addEventListener("change", renderAll);

      document.getElementById("btnPrev").addEventListener("click", ()=>shiftMonth(-1));
      document.getElementById("btnNext").addEventListener("click", ()=>shiftMonth(1));
      document.getElementById("btnToday").addEventListener("click", ()=>{
        const now2 = new Date();
        document.getElementById("month").value = monthISO(now2);
        renderAll();
      });

      renderAll();
    }

    init();
  </script>
</body>
</html>
